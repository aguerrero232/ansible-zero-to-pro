-
  name: commander google nslookup
  hosts: commanders
  vars:
    play_name: "{{ ansible_play_name }}"
    log_dir: "/target_logs"
  tasks:
    - name: printing nslookup test...
      ansible.builtin.debug:
        msg: "attempting nslookup of google.com..."

    - name: nslookup test...
      command: "nslookup google.com"
      register: result
      ignore_errors: true

    - shell: "dnf provides nslookup -q"
      register: result2
      ignore_errors: True
      when: result is failed
    
    - name: saving provides command result
      command: "echo {{ result2.stdout_lines[0] | regex_search('(.*)-[0-9]:?', '\\1') | first  }}"
      register: command_package
      when: result2 is success and result is failed 
    
    - name: printing provides command result
      ansible.builtin.debug:
        msg: " 📦 found {{ command_package.stdout_lines[0] }}, attempting to install..."
      when: result2 is success and result is failed and command_package is defined

    - name: installing command package
      command: "dnf -y install {{ command_package.stdout_lines[0] }}"
      when: result2 is success and result is failed and command_package is defined
 
    - name: retry nslookup after fail and install
      command: "nslookup google.com"
      register: result
 
    - name: print nslookup result
      ansible.builtin.debug:
        msg: "{{result}}"
      when: result is success

    - debug:
        msg: " ❌  command failed..."
      when: result is failed 

    - debug:
        msg: " 🔎  status changed..."
      when: result is changed

    - debug:
        msg: " ⏭️  command was skipped..."
      when: result is skipped

    - debug:
        msg: " ✔️  command succeeded..."
      when: result is success

    - name: logging commander event
      copy: 
        content: "{{result}}"
        dest: "{{log_dir}}/{{inventory_hostname}}-commander.txt"

